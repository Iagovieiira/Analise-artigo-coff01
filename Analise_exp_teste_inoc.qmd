---
title: "Analise_exp_teste_inoc"
format: html
editor: visual
---

## Pacotes

```{r}
#Pacotes carregados: 

library(gsheet)
library(tidyr)
library(tidyverse)
library(dplyr)
library(DHARMa)
library(performance)
library(agricolae)
library(epifitter)
library(ggthemes)
library(dendextend)
library(ggbiplot)
library(ggfortify)
library(plotly)
library(dplyr)
library(emmeans)
library(ggplot2)
library(lme4)       
library(lmerTest)   
library(multcomp)
library(survival)
library(survminer)
library(patchwork)
library(ggsci)
library(gridExtra)
library(RColorBrewer)

```

## Dataset

```{r}
#Importando dados:
exp <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1W674SFhpUPGBhhQQk7-KGhY5nj955AVE-SIxKey5Nnk/edit?usp=sharing") %>% 
  filter(DAI < 36) 
  

```

## Discos perdidos

```{r}
perda_inoc <- exp %>%
  separate(
    col = trat,  # verifique se o nome da coluna está correto
    into = c("TRAT", "tipo_inoc", "CULTIVAR"),
    sep = "-",
    remove = FALSE
  ) %>% 
  # filter(DPI < 36) %>%  # removido para o primeiro gráfico
  group_by(TRAT, tipo_inoc, DAI) %>%
  summarise(media = mean(Discos_totais, na.rm = TRUE)) %>%  # adicionado na.rm = TRUE
  ungroup() %>%  # importante para evitar problemas com o ggplot
  ggplot(aes(x = DAI, y = media, color = TRAT)) +
  geom_line(size = 2, alpha = 0.3) +
  facet_wrap(~tipo_inoc) +
  theme_minimal() +
  scale_y_continuous(
    breaks = seq(12, 16, 1), 
    limits = c(11.8, 16.2), 
    expand = c(0, 0)
  ) +
  theme(legend.position = "bottom") +
  labs(
    y = "Observational units",
    color = ""
  )

perda_inoc


perda_trat <- exp %>%
    separate(
    col = trat,
    into = c("TRAT", "tipo_inoc", "CULTIVAR"),
    sep = "-",  # Usando hífen como separador
    remove = FALSE) %>% 
  filter(DAI < 36) %>%
  group_by(TRAT, DAI) %>%
  summarise(media = mean(Discos_totais)) %>%
  ggplot(aes(x = DAI, y = media, color = TRAT)) +
  geom_line(size = 2, alpha = 0.3) +
  # facet_wrap(CULTIVAR~tipo_inoc + Raças) +
  theme_minimal()+
  scale_y_continuous(breaks = seq(12, 16, 1), limits = c(11.8, 16.2), expand = c(0, 0))+
  theme(legend.position = "bottom")+
  labs(
    # title = "Distribuição do Índice por DPI",
    # x = "Dias após inoculação",
    y = NULL,
    color = ""
  ) 

perda_trat

library(patchwork)

(perda_inoc + perda_trat) +
  plot_layout(guides = 'collect', axis_titles = 'collect', width  = c(1.0,1),) +
  plot_annotation(tag_levels = 'A')  &
  theme(plot.tag = element_text(face = 'bold'),
    legend.position = "bottom" 
  )


ggsave("Perda_comb.png", width = 7, height = 5, bg = "white",  dpi = 300)

```

# Analyse Sobrev.

```{r}
# Primeiro, vamos criar um dataframe no formato longo para análise de sobrevivência
# Cada disco será uma observação ao longo do tempo

dados_surv <- exp %>%
  separate(
    col = trat,
    into = c("TRAT", "tipo_inoc", "CULTIVAR"),
    sep = "-",
    remove = FALSE
  ) %>%
  # Ordenar por TRAT, tipo_inoc, DPI
  arrange(TRAT, tipo_inoc, DAI) %>%
  group_by(TRAT, tipo_inoc) %>%
  mutate(
    # Calcular a perda de discos entre DPI consecutivos
    perda_discos = lag(Discos_totais, default = first(Discos_totais)) - Discos_totais,
    # Evento = perda de disco (1 se perdeu, 0 se não perdeu)
    evento = ifelse(perda_discos > 0, 1, 0)
  ) %>%
  ungroup()

# Verificar a estrutura dos dados
head(dados_surv)

# 2. CRIAR DATAFRAME PARA ANÁLISE DE SOBREVIVÊNCIA
# Cada linha representa um "disco" que sobrevive até determinado DPI

surv_data <- data.frame()

# Para cada combinação de TRAT e tipo_inoc, criar observações individuais
grupos <- unique(dados_surv[, c("TRAT", "tipo_inoc")])

for(i in 1:nrow(grupos)) {
  trat_atual <- grupos$TRAT[i]
  inoc_atual <- grupos$tipo_inoc[i]
  
  # Filtrar dados para este grupo
  grupo_dados <- dados_surv %>%
    filter(TRAT == trat_atual, tipo_inoc == inoc_atual) %>%
    arrange(DAI)
  
  # Número inicial de discos
  discos_iniciais <- first(grupo_dados$Discos_totais)
  
  # Criar observações para cada disco
  for(disco in 1:discos_iniciais) {
    # Encontrar em qual DPI este disco foi perdido (se foi)
    perdido <- FALSE
    tempo_surv <- max(grupo_dados$DAI)  # tempo máximo de observação
    status <- 0  # 0 = censurado (não perdido até o final)
    
    for(j in 1:nrow(grupo_dados)) {
      dpi_atual <- grupo_dados$DAI[j]
      discos_atuais <- grupo_dados$Discos_totais[j]
      
      # Se o número de discos é menor que o índice do disco atual, ele foi perdido
      if(discos_atuais < disco) {
        perdido <- TRUE
        tempo_surv <- dpi_atual
        status <- 1  # 1 = evento (perda do disco)
        break
      }
    }
    
    # Adicionar ao dataframe
    surv_data <- rbind(surv_data, data.frame(
      TRAT = trat_atual,
      tipo_inoc = inoc_atual,
      disco_id = paste(trat_atual, inoc_atual, disco, sep = "_"),
      tempo = tempo_surv,
      status = status
    ))
  }
}

# 3. ANÁLISE DE SOBREVIVÊNCIA - KAPLAN-MEIER

# 3.1 Criar objeto Surv
sob_obj <- Surv(time = surv_data$tempo, event = surv_data$status)

# 3.2 Ajustar modelo Kaplan-Meier por TRAT
km_trat <- survfit(sob_obj ~ TRAT, data = surv_data)

# 3.3 Ajustar modelo Kaplan-Meier por TRAT e tipo_inoc
km_trat_inoc <- survfit(sob_obj ~ TRAT + tipo_inoc, data = surv_data)

# 3.4 Ajustar modelo considerando interação
surv_data$interacao <- interaction(surv_data$TRAT, surv_data$tipo_inoc)
km_interacao <- survfit(sob_obj ~ interacao, data = surv_data)

```

```{r}
# Configurar tema
theme_set(theme_minimal(base_size = 11))
theme_update(
  legend.position = "bottom",
  panel.grid.minor = element_blank(),
  plot.title = element_text(face = "bold", hjust = 0.5),
  plot.subtitle = element_text(hjust = 0.5, color = "gray40"),
  axis.title = element_text(face = "bold")
)

# Cores personalizadas
cores_trat <- c("#E64B35FF", "#4DBBD5FF", "#00A087FF", "#3C5488FF", "#F39B7FFF")
cores_inoc <- c("#8491B4FF", "#91D1C2FF", "#DC0000FF")

# Gráfico: Curvas de sobrevivência por tipo de inoculação
p2 <- ggsurvplot_facet(
  fit = survfit(Surv(tempo, status) ~ TRAT, data = surv_data),
  data = surv_data,
  facet.by = "tipo_inoc",
  ncol = length(unique(surv_data$tipo_inoc)),
  palette = cores_trat,
  
  # Estética das Linhas
  size = 1.1,                 # Linhas levemente mais grossas para destaque
  linetype = "solid",         # Garante que as cores sejam o foco
  alpha = 0.8,                # Leve transparência para sobreposições
  
  # Eixos e Legendas
  break.time.by = 7,
  xlab = "DAI",
  ylab = "Survival Probability",
  legend.title = "Treatment",
  
  # Tabelas de Risco e Configurações
  risk.table = TRUE,
  risk.table.height = 0.25,   # Aumentado levemente para não cortar números
  risk.table.y.text = FALSE,  # Remove o nome das labels na tabela para ganhar espaço
  
  # Tema e Estilo
  ggtheme = theme_bw() +      # theme_bw costuma ser melhor para publicações
    theme(
      strip.background = element_rect(fill = "grey90", color = "white"),
      strip.text = element_text(face = "bold", size = 12),
      panel.grid.minor = element_blank(),
      legend.position = "bottom"
    )
)

# Ajuste fino pós-criação (opcional mas recomendado)
p2 <- p2 + 
  ggplot2::guides(fill = guide_legend(nrow = 1)) +
  ggplot2::theme(legend.text = element_text(size = 10))

p2
```

```{r}
library(survival)
library(dplyr)

# Teste por tipo de inoculação
resultados <- surv_data %>%
  group_split(tipo_inoc) %>%
  lapply(function(df) {
    
    teste <- survdiff(Surv(tempo, status) ~ TRAT, data = df)
    
    pvalor <- 1 - pchisq(teste$chisq, length(teste$n) - 1)
    
    data.frame(
      tipo_inoc = unique(df$tipo_inoc),
      chisq = teste$chisq,
      gl = length(teste$n) - 1,
      p_value = pvalor
    )
  })

do.call(rbind, resultados)


cox_model <- coxph(Surv(tempo, status) ~ TRAT + tipo_inoc, data = surv_data)
summary(cox_model)


```

```{r}
library(survival)
library(emmeans)
library(multcomp)

letras_lista <- surv_data %>%
  group_split(tipo_inoc) %>%
  lapply(function(df) {
    
    df$TRAT <- as.factor(df$TRAT)
    
    cox_model <- coxph(Surv(tempo, status) ~ TRAT, data = df)
    
    emm <- emmeans(cox_model, "TRAT")
    
    letras <- multcomp::cld(
      emm,
      adjust = "BH",
      Letters = letters
    )
    
    data.frame(
      TRAT = letras$TRAT,
      letra = trimws(letras$.group),
      tipo_inoc = unique(df$tipo_inoc)
    )
  })

letras_df <- do.call(rbind, letras_lista)

letras_df
```

```{r}
dados_proporcao <- surv_data %>%
  group_by(TRAT, tipo_inoc) %>%
  summarise(
    sobreviventes = sum(status == 0),
    perdidos = sum(status == 1),
    total = n(),
    perc_sobrev = sobreviventes / total * 100,
    .groups = 'drop'
  ) %>%
  pivot_longer(
    cols = c(sobreviventes, perdidos),
    names_to = "status",
    values_to = "n"
  )

grafico_stacked <- ggplot(dados_proporcao, 
                         aes(x = TRAT, y = n, fill = status)) +
  geom_col(position = "fill", width = 0.7) +
  facet_wrap(~ tipo_inoc) +
  scale_fill_manual(
    values = c("sobreviventes" = "#00A087FF", "perdidos" = "#E64B35FF"),
    labels = c("Sobreviventes", "Perdidos")
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  coord_flip() +
  labs(
    title = "Proporção de discos ao longo do tempo",
    x = "Tratamento",
    y = "Proporção",
    fill = "Status",
    subtitle = "Ao final do período experimental"
  ) +
  theme(
    panel.grid.major.x = element_line(color = "gray90"),
    panel.grid.major.y = element_blank(),
    strip.background = element_rect(fill = "gray95", color = NA)
  )

grafico_stacked


```

## Index

```{r}
dados <- exp |>
  pivot_longer(cols = c("1","2","3","4","5","6"), names_to = "notas", values_to = "n.discos")
dados$notas <- as.numeric(dados$notas)

dados <- dados |> 
  mutate(n.discos = ifelse(is.na(n.discos),0,n.discos))

# dados1 <- dados %>%
#   group_by(Cultivar,Raças,Reps,DPI) %>%
#   mutate(index = round(sum(notas * n.discos) / (Discos_totais*6), 3)) #vezes 6 pois é o maior nivel da escala, vide indice de Mckeney
# 
# dados1 <- dados1 |> 
#   filter(notas == 1) |> 
#   select(-c(notas,n.discos))


dados1 <- dados %>%
   filter(Discos_totais != 0) %>% 
  # group_by(Cultivar,exp, Raças,Reps,DPI) %>%
  # filter(DPI == 37) %>% 
   # group_by(trat,Raças,Reps,DPI,exp) %>% 
  mutate(nota_disco = round(notas * n.discos*100) / (Discos_totais*6), 3)%>%  #vezes 6 pois é o maior nivel da escala, vide indice de Mckeney
  group_by(trat,Raças,Reps,DAI,exp) %>%
  summarise(index = sum(nota_disco))


# dados_index <- dados |>
#   filter(Discos_totais != 0) 
#   
```

```{r}
# dados <- exp |>
#   pivot_longer(cols = c("1","2","3","4","5","6"), names_to = "notas", values_to = "n.discos")
# dados$notas <- as.numeric(dados$notas)
# 
# dados <- dados |> 
#   mutate(n.discos = ifelse(is.na(n.discos),0,n.discos))
# 
# dados1 <- dados %>%
#   group_by(trat,Raças,Reps,DPI,exp) %>% 
#   mutate(index = round(sum(notas * n.discos) / (Discos_totais*6), 3)) #vezes 6 pois é o maior nivel da escala, vide indice de Mckeney
# 
# dados1 <- dados1 |> 
#  filter(notas == 1, !is.nan(index)) |> 
#   dplyr::select(-c(notas,n.discos))

#filtrar por tratamentos estavem dando NaN 
```

## AUDPC

```{r}
# calcular AUDPC 



dadosaudpc <- dados1 |>
  # filter(Discos_totais != 0) %>% 
  group_by(trat, Raças, exp, Reps) |> 
  summarise(audpc = AUDPC(DAI,index, y_proportion = TRUE, type = "absolute"))
  # left_join(dados_index)# lRepseft_join(dados_index)


# dadosaudpc <-  dados1 |> 
#   ungroup() %>% 
#   group_by(Cultivar,Raças) |> 
#   mutate(AUDPC = AUDPC(DPI,index, y_proportion = TRUE, type = "absolute"))
# 
# dadosaudpc
# 
# dadosaudpc <- dadosaudpc |> 
# filter(DPI == 37) %>% 
#   group_by(exp, Cultivar, Raças, Reps) %>% 
#   summarise(index = mean(index), AUDPC = mean(AUDPC))
# 
# dadosaudpc
```

## AUDPC

```{r}
# dadosaudpc <- dados1 |> 
#   group_by(trat, Raças) |> 
#   mutate(AUDPC = AUDPC(DPI, index, y_proportion = TRUE, type = "absolute"))
# 
# dadosaudpc <- dadosaudpc |> 
#   filter(DPI == 35) %>% 
#   group_by(trat, Raças, Reps) %>% 
#   summarise(
#     index = mean(index), 
#     AUDPC = mean(AUDPC),
#     .groups = "drop" 
#   )

#m_audpc <- lmer(AUDPC ~ trat + (1|Raças),
                   #data = dadosaudpc)




```

## PI PL

```{r}
# gerar PL e PI 
dados.PI.PL <- dados %>%
  # Primeiro, agregue os valores duplicados
  group_by(trat, Raças, Reps, DAI,exp, Discos_totais, notas) %>%
  summarise(
    n.discos = sum(n.discos, na.rm = TRUE),  # ou mean(), max(), etc
    .groups = "drop"
  ) %>%
  # Agora faça o pivot
  pivot_wider(
    names_from = notas, 
    values_from = n.discos,
    values_fn = sum  # Garante que quaisquer duplicatas restantes sejam somadas
  ) %>%
  # Converta para numérico
  mutate(across(c(6:12), as.numeric))



dados.PI.PL <- dados.PI.PL %>% 
  mutate(PI.1 = ifelse(`2` >= 1, DAI, 100),
         PI.2 = ifelse(`2` >= (Discos_totais/3), DAI, 100),
         PL.1 = ifelse(`4` >= 1, DAI, 100),
         PL.2 = ifelse(`4` >= (Discos_totais/3), DAI, 100))

dados.PI.PL <- dados.PI.PL %>% 
  group_by(trat, Raças, Reps,exp) %>% 
  mutate(PI.1 = min(PI.1, na.rm = T),
         PI.2 = min(PI.2, na.rm = T),
         PL.1 = min(PL.1, na.rm = T),
         PL.2 = min(PL.2, na.rm = T))

dados.PI.PL <- dados.PI.PL %>% 
  mutate(PI.1 = ifelse(PI.1 == 100, NA, PI.1),
         PI.2 = ifelse(PI.2 == 100, NA, PI.2),
         PL.1 = ifelse(PL.1 == 100, NA, PL.1),
         PL.2 = ifelse(PL.2 == 100, NA, PL.2))

dados.PI.PL <- dados.PI.PL %>% 
  filter(DAI == 35) %>% 
  dplyr::select(-DAI)

dados.PI.PL

```

```{r}
#Compilando variáveis: INDEX, AUDPC, PI, PL


dados2 <- dadosaudpc %>% 
  left_join(dados1) %>% 
  left_join(dados.PI.PL) %>% 
  dplyr::select(trat, exp, Raças, DAI, Reps, index, audpc, PI = PI.2, PL = PL.2, PI.1, PL.1)
  
dados2


# dados2 <- merge(dadosaudpc,dados1, by = c("trat", "Raças", "Reps"), all.x = TRUE)
# dados2 <- merge(dados2, dados.PI.PL, by = c("trat", "Raças", "Reps"), all.x = TRUE)
# 
# dados2 <- merge(dados2 [ , c(1,2,3,8,5,17,18,19,20)], dados1, by = c("trat", "Raças", "Reps", "exp"), all.y = TRUE)
  
  
```

# separa vars

```{r}
library(tidyverse)

# Verifique primeiro o formato exato dos dados
head(dados1$trat, 10)

# Solução 1: Quando o separador é "-" (hífen)
dados2_separados <- dados2 %>%
  separate(
    col = trat,
    into = c("TRAT", "tipo_inoc", "CULTIVAR"),
    sep = "-",  # Usando hífen como separador
    remove = FALSE
  )


# Verificar a estrutura do dataframe
str(dados2_separados)

# Ou apenas os nomes das colunas
names(dados2_separados)



```

exp1

```{r}

exp1 <- exp %>% 
  dplyr::select(trat, Raças, exp, Reps, DAI, Discos_totais) %>% 
  separate(col = trat, into = c("TRAT", "tipo_inoc", "CULTIVAR"), sep = " - ")

exp1 %>% 
  filter(DAI <= 35) %>% 
group_by(TRAT, DAI, Raças, CULTIVAR, tipo_inoc) %>% 
  summarise(media = mean(Discos_totais)) %>% 
  ggplot(aes(x = DAI, y = media, color = TRAT)) +
  geom_line(size = 2, alpha = 0.3) +
  facet_wrap(CULTIVAR~tipo_inoc + Raças) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(color = "",
       x = "DAI",
       y = "Observational units")

ggsave("Perda_de_disco_ao_longo_do_tempo_minimal.png", width = 150, height = 200, dpi = 300, units = "mm")
```

```{r}

#dados <- dados |> 
  #mutate(n.discos = ifelse(is.na(n.discos),0,n.discos)) 

  #fazer para os dias separados esta filtrado a 21, 28 e 35 dpi

ggplot(dados2_separados %>% filter(DAI == 21), 
       aes(x = TRAT, y = index, fill = CULTIVAR)) +
  geom_boxplot(alpha = 0.8, outlier.shape = 19, outlier.size = 2) +
  facet_wrap(~ tipo_inoc + Raças) +
  labs(
    title = "Distribuição do Índice (DAI = 21 dias)",
    x = "Tipo de Inoculação",
    y = "Valor do Índice",
    fill = "Cultivar"
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    strip.text = element_text(face = "bold"),
    legend.position = "top",
    panel.spacing = unit(1, "lines"),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14)
  ) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 1.5)

#28DPI 
ggplot(dados2_separados %>% filter(DAI == 28), 
       aes(x = TRAT, y = index, fill = CULTIVAR)) +
  geom_boxplot(alpha = 0.8, outlier.shape = 19, outlier.size = 2) +
  facet_wrap(~ tipo_inoc + Raças) +
  labs(
    title = "Distribuição do Índice (DAI = 28 dias)",
    x = "Tipo de Inoculação",
    y = "Valor do Índice",
    fill = "Cultivar"
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    strip.text = element_text(face = "bold"),
    legend.position = "top",
    panel.spacing = unit(1, "lines"),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14)
  ) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 1.5)

#35 DPI

ggplot(dados2_separados %>% filter(DAI == 35), 
       aes(x = TRAT, y = index, fill = CULTIVAR)) +
  geom_boxplot(alpha = 0.8, outlier.shape = 19, outlier.size = 0) +
  facet_wrap(~ tipo_inoc + Raças) +
  labs(
    title = "Distribuição do Índice (DAI = 35 dias)",
    x = "Tipo de Inoculação",
    y = "Valor do Índice",
    fill = "Cultivar"
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_few(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    strip.text = element_text(face = "bold"),
    legend.position = "top",
    panel.spacing = unit(1, "lines"),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14)
  ) 
 # geom_jitter(width = 0.2, alpha = 0.5, size = 1.5)



```

```{r}
library(ggplot2)
library(dplyr)

# Primeiro, certifique-se que DPI é um fator (se necessário)
dados2_separados <- dados2_separados %>%
  mutate(DPI = factor(DAI, levels = c(21, 28, 35)))

# Gráfico combinado
ggplot(dados2_separados %>% filter(DPI %in% c(21, 28, 35)), 
       aes(x = TRAT, y = index, fill = CULTIVAR)) +
  geom_boxplot(alpha = 0.8, outlier.shape = 0, outlier.size = 0) +
  facet_grid(DAI ~ tipo_inoc + Raças, scales = "free_x") +  # DPI como linhas
  labs(
    title = "",
    x = "Type of Inoculation",
    y = "Disease index (%)",
    fill = ""
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    strip.text = element_text(face = "bold"),
    legend.position = "bottom",
    panel.spacing = unit(1, "lines"),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    plot.subtitle = element_text(hjust = 0.5)
  ) +
  ylim(0,100)
 # geom_jitter(width = 0.2, alpha = 0.5, size = 1.5)

# Para salvar o gráfico
ggsave("boxplot_combinado_DPI.png", width = 150, height = 200, dpi = 300, units = "mm")
```

## Modelo misto

### Index

```{r}
dados3_filtrados <- dados2_separados %>% 
  filter(DAI == 35)
  
modelo_misto <- lmer(index ~ TRAT * tipo_inoc +  (1|CULTIVAR/Raças),      # Efeitos fixos
                     # (1|CULTIVAR) +
                     # (1|Raças) ,
                   data = dados3_filtrados)

#check_normalidade_dos_dados
plotQQunif(modelo_misto)
testUniformity(modelo_misto)

library(DHARMa)
plot(simulateResiduals(modelo_misto))

car::Anova(modelo_misto, type = "III")


# Calcular médias marginais
 ems <- emmeans(modelo_misto, pairwise ~ TRAT*tipo_inoc, type = "response")
# ems <- emmeans(modelo_misto,  ~ TRAT*tipo_inoc,  type = "response")

# medias_species <- emmeans(mix1,  ~ species*host, type = "response")
# summary(ems, by = "TRAT")
# summary(ems, by = "tipo_inoc")
# 
# pairs(ems, by = "TRAT")
# 
# pairs(ems, by = "tipo_inoc")


# Obter letras de grupos
grupos <- cld(ems$emmeans, 
              by ="TRAT",
              # by=  "tipo_inoc",
             Letters = letters,  # Usar letras minúsculas
             # adjust = "tukey",   # Ajuste de Tukey
             alpha = 0.05)       # Nível de significância


grupos
grupos$tipo_inoc


g_index <- grupos|>  
  as.data.frame() |>
  ggplot(aes(TRAT, emmean, ymin = emmean-SE, ymax= emmean+SE, color = tipo_inoc))+
  geom_errorbar(size = 1, width = 0.1, position = position_dodge(width = 0.5))+
  geom_point( size = 3, position = position_dodge(width = 0.5))+
  labs(y = "Indice de doença (%)", x = NULL, color = "")+
  theme(
    axis.text.x = element_blank(),   # remove os textos
    axis.ticks.x = element_blank())+
      theme_bw()+
  # geom_text(aes(x = TRAT, y = emmean + SE +0.05, label = .group),
            # position = position_nudge(x = 0),
            # size = 3.5)+
  scale_y_continuous(breaks = seq(0, 100, 20), limits = c(-5, 105), expand = c(0, 0))+
  theme(legend.position = "bottom"
        # axis.text.x = element_text(angle = 45, hjust = 1)
        )
 
g_index

```

### AUDPC

```{r}


modelo_misto <- lmer(audpc ~ TRAT * tipo_inoc +  (1|CULTIVAR/Raças),      # Efeitos fixos
                     # (1|CULTIVAR) +
                     # (1|Raças) ,
                   data = dados3_filtrados)

#check_normalidade_dos_dados
plotQQunif(modelo_misto)
testUniformity(modelo_misto)

library(DHARMa)
plot(simulateResiduals(modelo_misto))

car::Anova(modelo_misto, type = "III")


# Calcular médias marginais
 ems <- emmeans(modelo_misto, pairwise ~ TRAT*tipo_inoc, type = "response")
# ems <- emmeans(modelo_misto,  ~ TRAT*tipo_inoc,  type = "response")

# medias_species <- emmeans(mix1,  ~ species*host, type = "response")
# summary(ems, by = "TRAT")
# summary(ems, by = "tipo_inoc")
# 
# pairs(ems, by = "TRAT")
# 
# pairs(ems, by = "tipo_inoc")


# Obter letras de grupos
grupos <- cld(ems$emmeans, 
              # by ="TRAT", 
              # by=  "tipo_inoc",
             Letters = letters,  # Usar letras minúsculas
             # adjust = "tukey",   # Ajuste de Tukey
             alpha = 0.05)       # Nível de significância


grupos

g_AUDPC <- grupos|>  
  as.data.frame() |>
  ggplot(aes(TRAT, emmean, ymin = emmean-SE, ymax= emmean+SE, color = tipo_inoc))+
  geom_errorbar(size = 1, width = 0.1, position = position_dodge(width = 0.5))+
  geom_point( size = 3, position = position_dodge(width = 0.5))+
  labs(y = "AUDPC", x = NULL, color = "")+
  theme(
    axis.text.x = element_blank(),   # remove os textos
    axis.ticks.x = element_blank())+
      theme_bw()+
  # geom_text(aes(x = TRAT, y = emmean + SE +0.05, label = .group),
            # position = position_nudge(x = 0),
            # size = 3.5)+
  scale_y_continuous(breaks = seq(0, 1200, 200), limits = c(-50, 1250), expand = c(0, 0))+

  theme(legend.position = "bottom"
        # axis.text.x = element_text(angle = 45, hjust = 1)
        )
        
  
g_AUDPC

```

### PI

```{r}

modelo_misto <- lmer(PI ~ TRAT * tipo_inoc +  (1|CULTIVAR/Raças),      # Efeitos fixos
                     # (1|CULTIVAR) +
                     # (1|Raças) ,
                   data = dados3_filtrados)

#check_normalidade_dos_dados
plotQQunif(modelo_misto)
testUniformity(modelo_misto)

library(DHARMa)
plot(simulateResiduals(modelo_misto))

car::Anova(modelo_misto, type = "III")


# Calcular médias marginais
 ems <- emmeans(modelo_misto, pairwise ~ tipo_inoc, type = "response")
# ems <- emmeans(modelo_misto,  ~ TRAT*tipo_inoc,  type = "response")

# medias_species <- emmeans(mix1,  ~ species*host, type = "response")
# summary(ems, by = "TRAT")
# summary(ems, by = "tipo_inoc")
# 
# pairs(ems, by = "TRAT")
# 
# pairs(ems, by = "tipo_inoc")


# Obter letras de grupos
grupos <- cld(ems$emmeans, 
              # by ="TRAT", 
              # by=  "tipo_inoc",
             Letters = letters,  # Usar letras minúsculas
             # adjust = "tukey",   # Ajuste de Tukey
             alpha = 0.05)       # Nível de significância

grupos

g_PI <- grupos|>  
  as.data.frame() |>
  ggplot(aes(tipo_inoc, emmean, ymin = emmean-SE, ymax= emmean+SE, color = tipo_inoc))+
  geom_errorbar(size = 1, width = 0.1, position = position_dodge(width = 0.5))+
  geom_point( size = 3, position = position_dodge(width = 0.5))+
  labs(y = "IP (days)", x = NULL, color = "")+
  theme(
    axis.text.x = element_blank(),   # remove os textos
    axis.ticks.x = element_blank())+
      theme_bw()+
  # geom_text(aes(x = TRAT, y = emmean + SE +0.05, label = .group),
            # position = position_nudge(x = 0),
            # size = 3.5)+
 scale_y_continuous(breaks = seq(0, 35, 7), limits = c(-2, 37), expand = c(0, 0))+
  theme(legend.position = "bottom"
        # axis.text.x = element_text(angle = 45, hjust = 1)
        )
g_PI

```

### PL

```{r}
modelo_misto <- lmer(PL ~ TRAT * tipo_inoc +  (1|CULTIVAR/Raças),      # Efeitos fixos
                     # (1|CULTIVAR) +
                     # (1|Raças) ,
                   data = dados3_filtrados)




#check_normalidade_dos_dados
plotQQunif(modelo_misto)
testUniformity(modelo_misto)

library(DHARMa)
plot(simulateResiduals(modelo_misto))

car::Anova(modelo_misto, type = "III")


# Calcular médias marginais
 ems <- emmeans(modelo_misto, pairwise ~ tipo_inoc, type = "response")
# ems <- emmeans(modelo_misto,  ~ TRAT*tipo_inoc,  type = "response")

# medias_species <- emmeans(mix1,  ~ species*host, type = "response")
# summary(ems, by = "TRAT")
# summary(ems, by = "tipo_inoc")
# 
# pairs(ems, by = "TRAT")
# 
# pairs(ems, by = "tipo_inoc")


# Obter letras de grupos
grupos <- cld(ems$emmeans, 
              # by ="TRAT", 
              # by=  "tipo_inoc",
             Letters = letters,  # Usar letras minúsculas
             # adjust = "tukey",   # Ajuste de Tukey
             alpha = 0.05)       # Nível de significância


grupos



g_PL <- grupos|>  
  as.data.frame() |>
  ggplot(aes(tipo_inoc, emmean, ymin = emmean-SE, ymax= emmean+SE, color = tipo_inoc))+
  geom_errorbar(size = 1, width = 0.1, position = position_dodge(width = 0.5))+
  geom_point( size = 3, position = position_dodge(width = 0.5))+
  labs(y = "LP (days)", x = NULL, color = "")+
  theme(
    axis.text.x = element_blank(),   # remove os textos
    axis.ticks.x = element_blank())+
      theme_bw()+
  # geom_text(aes(x = TRAT, y = emmean + SE +0.05, label = .group),
            # position = position_nudge(x = 0),
            # size = 3.5)+
 scale_y_continuous(breaks = seq(0, 35, 7), limits = c(-2, 37), expand = c(0, 0))+
  theme(legend.position = "bottom"
        # axis.text.x = element_text(angle = 45, hjust = 1)
        )


g_PL


```

## Gráficos combinados

```{r}
library(patchwork)

# g_index <- g_index +
#   theme(
#     axis.text.x = element_blank(),
#     axis.ticks.x = element_blank()
#   )
# 
# g_AUDPC <- g_AUDPC +
#   theme(
#     axis.text.x = element_blank(),
#     axis.ticks.x = element_blank()
#   )

 g_comp <- ((g_index + g_AUDPC) / (g_PI + g_PL)) + plot_layout(guides = 'collect',  width  = c(1.0,1),) +
  plot_annotation(tag_levels = 'A') &
  theme(plot.tag = element_text(face = 'bold'),
        legend.position = "bottom")
#  
# g__períodos <- (g_PI + g_PL) + plot_layout(guides = 'collect', axis_titles = 'collect', width  = c(1.0,1),) +
#   plot_annotation(tag_levels = 'A') &
#   theme(plot.tag = element_text(face = 'bold'))
# 
# 
# library(patchwork)
# g_comp <- g_index + g_AUDPC + g_PI + g_PL

g_comp


```

```{r}

ggsave("g_comp.png", dpi = 300)

```

# Teste spray x pincel

```{r}
#Importando dados:

te1 <- gsheet2tbl ("https://docs.google.com/spreadsheets/d/1RXGus0WWIns3yKFwRSjWACrxUrV9ssCo/edit?gid=1989718288#gid=1989718288")
```

```{r}
# Assumindo que 'te1' é seu dataframe

# Calculando a média de 'sinal'
sinal_mean <- te1 %>%
  group_by(dpi, metodo) %>%
  summarise(media_sinal = mean(sinal, na.rm = TRUE))

# Calculando a média de 'sintoma'
sintoma_mean <- te1 %>%
  group_by(dpi, metodo) %>%
  summarise(media_sintoma = mean(sintoma, na.rm = TRUE))

# Calculando a média de 'nada'
nada_mean <- te1 %>%
  group_by(dpi, metodo) %>%
  summarise(media_nada = mean(`Sem Sintoma`, na.rm = TRUE))

# Gráfico 1: Média de Sinal
sinal_bar <- ggplot(sinal_mean, aes(x = factor(dpi), y = media_sinal, fill = metodo)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  scale_x_discrete(breaks = c("21", "28", "42")) +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0, 85, 20), limits = c(-2, 87), expand = c(0, 0))+
  labs(x = "DAI", y = "Frequency (%)", 
       fill = "Inoculation Method") +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))

# Gráfico 2: Média de Sintoma
sintoma_bar <- ggplot(sintoma_mean, aes(x = factor(dpi), y = media_sintoma, fill = metodo)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  scale_x_discrete(breaks = c("21", "28", "42")) +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0, 85, 20), limits = c(-2, 87), expand = c(0, 0))+
  labs(x = "DAI", y = NULL, 
       fill = "Inoculation Method") +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))

# Gráfico 3: Média de Nada
nada_bar <- ggplot(nada_mean, aes(x = factor(dpi), y = media_nada, fill = metodo)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  scale_x_discrete(breaks = c("21", "28", "42")) +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0, 85, 20), limits = c(-2, 87), expand = c(0, 0))+
  labs(x = "DAI", y = NULL, 
       fill = "Inoculation Method") +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))

# Combinando os gráficos

ss_comb <- (sinal_bar + sintoma_bar + nada_bar) +
  plot_layout(
    guides = 'collect',
    axis_titles = 'collect',
    width  = c(1,1,1),
    ncol = 3           # <- todos na mesma linha
  ) +
  plot_annotation(tag_levels = 'A') &
  theme(
    plot.tag = element_text(face = 'bold'),
    legend.position = "bottom"
  )
    
ss_comb
```

```{r}
#Gráfico 1: Sinal

sin_strip <- te1 |>
  ggplot(aes(x = factor(dpi), y = sinal, color = metodo)) +
  geom_jitter(width = 0.1, size = 2, alpha = 0.7) +
  scale_x_discrete(breaks = c("21", "28", "42")) +
  theme_minimal() +
  labs(title = "Sinal", x = "DPI", y = "Sinal") +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))



# Gráfico 2: Sintoma

sint_strip <- te1 |>

ggplot(aes(x = factor(dpi), y = sintoma, color = metodo)) +
  geom_jitter(width = 0.1, size = 2, alpha = 0.7) +
  scale_x_discrete(breaks = c("21", "28", "42")) +
  theme_minimal() +
  labs(title = "Sintoma", x = "DPI", y = "Sintoma") +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))



# Gráfico 3: Nada

nad_strip <- te1 |>
  ggplot(aes(x = factor(dpi), y = 'Sem Sintoma', color = metodo)) +
  geom_jitter(width = 0.1, size = 2, alpha = 0.7) +
  scale_x_discrete(breaks = c("21", "28", "42")) +
  theme_minimal() +
  labs(title = "Nada", x = "DPI", y = "Nada") +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))



# Combina todos os gráficos

sin_strip + sint_strip + nad_strip +
  plot_layout(guides = 'collect') +
  plot_annotation(title = "Comparação Spray x Pincel (Stripchart)")

```

## Teste QUI-QUADRADO

```{r}
#Importando dados:

dados <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1RXGus0WWIns3yKFwRSjWACrxUrV9ssCo/edit?gid=230666377#gid=230666377")

```

```{r}
dados <- dados |> 
  dplyr::select(`Suspenção de esporos` = `AV 3 (42 DAI) Spray`, Pincel = `AV 3 (42 DAI) Pincel`)
dados <- dados |> 
  pivot_longer(cols = c(`Suspenção de esporos`, Pincel), names_to = "method", values_to = "response")

contingence_table <- table(dados$method, dados$response)

result <- chisq.test(contingence_table)
result
contingence_table

# Teste qui-quadrado em pares
cont.table_sinal <- contingence_table[ , 2]
chisq.test(cont.table_sinal)

cont.table_sintoma <- contingence_table[ , 3]
chisq.test(cont.table_sintoma)

cont.table_sadio <- contingence_table[ , 1]
chisq.test(cont.table_sadio)

# Criando o gráfico
ggplot(dados, aes(x = method, fill = response)) +
  geom_bar(position = "dodge", color = 'white') +
  labs(x = "Método de Inoculação",
       y = "Frequência",
       fill = "") +
  theme_minimal() +
  ylim(0, 60) + 
  theme(legend.position = "bottom")

ggsave("freq_resposta_metodo_inoculacao.jpeg", device = "jpeg", units = "mm", dpi = 300, width = 90, height = 80)
```
